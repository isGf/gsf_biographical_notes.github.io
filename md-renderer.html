<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Markdown 文档</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        /* 全局背景色 */
        html, body {
            background-color: #ffffff;
            margin: 0;
            padding: 0;
        }
        
        .md-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            display: flex;
            gap: 20px;
            margin-top: 80px;
        }
        
        .md-sidebar {
            width: 250px;
            background-color: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            height: fit-content;
            position: sticky;
            top: 100px;
        }
        
        .md-sidebar ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        
        .md-sidebar li {
            margin-bottom: 10px;
        }

        .md-sidebar h3 {
            color: #000000;
            margin-top: 25px;
            margin-bottom: 10px;
        }
        
        .md-sidebar a {
            color: #333;
            text-decoration: none;
            display: block;
            padding: 8px 12px;
            border-radius: 5px;
            transition: all 0.3s ease;
            font-size: 14px;
        }
        
        .md-sidebar a:hover {
            background-color: #e9ecef;
            color: #007bff;
        }
        
        .md-sidebar a.active {
            background-color: #007bff;
            color: white;
        }
        
        .md-content {
            flex: 1;
            background-color: #fff;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            line-height: 1.8;
        }
        
        .md-content h1 {
            color: #007bff;
            text-align: center;
            border-bottom: 2px solid #3498db;
            padding-bottom: 10px;
            margin-bottom: 50px;
        }
        
        .md-content h2 {
            color: #181818;
            margin-top: 30px;
            margin-bottom: 15px;
            padding-bottom: 5px;
            border-bottom: 1px solid #eee;
        }
        
        .md-content h3 {
            color: #000000;
            margin-top: 25px;
            margin-bottom: 10px;
        }
        
        .md-content h4 {
            color: #000000;
            margin-top: 20px;
            margin-bottom: 10px;
        }
        
        .md-content h5 {
            color: #000000;
            margin-top: 15px;
            margin-bottom: 10px;
        }
        
        .md-content h6 {
            color: #000000;
            margin-top: 15px;
            margin-bottom: 10px;
            font-size: 0.9em;
        }
        
        .md-content p {
            margin-bottom: 15px;
            color: #000;
        }
        
        .md-content ul, .md-content ol {
            padding-left: 20px;
        }
        
        .md-content li {
            color: #000;
        }
        
        .md-content img {
            max-width: 100%;
            height: auto;
            border-radius: 8px;
            margin: 20px 0;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .md-content a {
            color: #007bff;
            text-decoration: none;
        }
        
        .md-content a:hover {
            text-decoration: underline;
        }
        
        .loading {
            text-align: center;
            padding: 50px;
            font-size: 18px;
            color: #666;
        }
        
        .error {
            text-align: center;
            padding: 50px;
            color: #e74c3c;
            font-size: 18px;
        }
        
        .back-button {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 10px 20px;
            background-color: #3498db;
            color: white;
            text-decoration: none;
            border-radius: 5px;
            transition: background-color 0.3s;
            z-index: 1001;
        }
        
        .back-button:hover {
            background-color: #2980b9;
        }
        
        /* 确保所有强调文本为黑色 */
        .md-content strong,
        .md-content b {
            color: #131313 !important;
            font-weight: 700;
        }
        
        /* 代码块样式 */
        .md-content pre {
            background-color: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 5px;
            padding: 15px;
            overflow-x: auto;
            margin: 15px 0;
        }
        
        .md-content code {
            background-color: #f1f3f4;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
        }
        
        .md-content pre code {
            background-color: transparent;
            padding: 0;
            border-radius: 0;
        }
        
        /* 表格样式 */
        .md-content table {
            border-collapse: collapse;
            width: 100%;
            margin: 20px 0;
        }
        
        .md-content th, .md-content td {
            border: 1px solid #ddd;
            padding: 12px;
            text-align: left;
        }
        
        .md-content th {
            background-color: #f8f9fa;
            font-weight: bold;
        }

    </style>
</head>
<body>
    <a href="index.html" class="back-button">返回首页</a>
    
    <div class="md-container">
        <aside class="md-sidebar">
            <h3>目录</h3>
            <ul id="md-toc"></ul>
        </aside>
        
        <main class="md-content" id="md-content">
            <div class="loading">正在加载文档...</div>
        </main>
    </div>

    <script>
        // 内置的轻量级markdown解析器，无需外部依赖
        const marked = {
            parse: function(text) {
                let html = text;
                
                // 处理代码块
                html = html.replace(/```(\w+)?\n([\s\S]*?)```/g, '<pre><code class="language-$1">$2</code></pre>');
                html = html.replace(/`([^`]+)`/g, '<code>$1</code>');
                
                // 处理标题
                html = html.replace(/^#### (.*$)/gim, '<h4>$1</h4>');
                html = html.replace(/^### (.*$)/gim, '<h3>$1</h3>');
                html = html.replace(/^## (.*$)/gim, '<h2>$1</h2>');
                html = html.replace(/^# (.*$)/gim, '<h1>$1</h1>');
                
                // 处理加粗和斜体
                html = html.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
                html = html.replace(/\*(.*?)\*/g, '<em>$1</em>');
                html = html.replace(/__(.*?)__/g, '<strong>$1</strong>');
                html = html.replace(/_(.*?)_/g, '<em>$1</em>');
                
                // 处理图片 - 修复相对路径问题（优先处理，避免被链接处理影响）
                html = html.replace(/!\[([^\]]*)\]\(([^)]+)\)/g, function(match, alt, src) {
                    // 处理相对路径，转换为相对于根目录的路径
                    let imagePath = src.trim();
                    
                    if (imagePath.startsWith('../')) {
                        // 处理 ../../../blogs/imgs/... 的情况
                        // 直接去掉前面的../，保留后面的路径
                        imagePath = imagePath.replace(/^(\.\.\/)+/, '');
                    } else if (imagePath.startsWith('./')) {
                        // 处理 ./ 当前目录
                        imagePath = imagePath.substring(2);
                    }
                    
                    // 确保路径是相对于根目录的
                    if (!imagePath.startsWith('blogs/') && !imagePath.startsWith('/')) {
                        imagePath = 'blogs/' + imagePath;
                    }
                    
                    return `<img alt="${alt}" src="${imagePath}" style="max-width: 100%; height: auto; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); cursor: pointer;" onclick="window.open('${imagePath}', '_blank')" />`;
                });
                
                // 处理链接（在图片之后处理，避免影响图片语法）
                html = html.replace(/([^!])\[([^\]]+)\]\(([^)]+)\)/g, '$1<a href="$3">$2</a>');
                
                // 处理列表
                html = html.replace(/^\* (.+)$/gim, '<ul><li>$1</li></ul>');
                html = html.replace(/^- (.+)$/gim, '<ul><li>$1</li></ul>');
                html = html.replace(/^\d+\. (.+)$/gim, '<ol><li>$1</li></ol>');
                
                // 处理表格
                html = html.replace(/\n\|(.+)\|\n\|[-:|\s]+\|\n((\|.+\|\n)+)/g, function(match, header, rows) {
                    const headers = header.split('|').map(h => h.trim()).filter(h => h);
                    const tableRows = rows.trim().split('\n').map(row => {
                        const cells = row.split('|').map(c => c.trim()).filter(c => c);
                        return '<tr>' + cells.map(cell => `<td>${cell}</td>`).join('') + '</tr>';
                    }).join('');
                    return '<table><thead><tr>' + headers.map(h => `<th>${h}</th>`).join('') + '</tr></thead><tbody>' + tableRows + '</tbody></table>';
                });
                
                // 处理换行
                html = html.replace(/\n\n/g, '</p><p>');
                html = html.replace(/\n/g, '<br>');
                
                // 包装段落
                if (!html.startsWith('<')) {
                    html = '<p>' + html + '</p>';
                }
                
                return html;
            }
        };
        
        // 移除等待marked库的函数，现在直接使用内置版本
        // 获取URL参数
        function getQueryParam(name) {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get(name);
        }

        // 生成目录
        function generateTOC(htmlContent) {
            const toc = document.getElementById('md-toc');
            const headings = htmlContent.match(/<h[2-6][^>]*>(.*?)<\/h[2-6]>/gi);
            
            if (!headings) return;
            
            headings.forEach((heading, index) => {
                const level = parseInt(heading.match(/<h(\d)/)[1]);
                const text = heading.replace(/<[^>]*>/g, '');
                const id = heading.match(/id="([^"]*)/)?.[1] || `heading-${index}`;
                
                const li = document.createElement('li');
                const link = document.createElement('a');
                link.href = `#${id}`;
                link.textContent = text;
                link.style.paddingLeft = `${(level - 2) * 10}px`;
                
                li.appendChild(link);
                toc.appendChild(li);
            });
        }

        // 加载并渲染Markdown
        async function loadMarkdown() {
            const mdFile = getQueryParam('file');
            const contentDiv = document.getElementById('md-content');
            
            if (!mdFile) {
                contentDiv.innerHTML = '<div class="error">未指定Markdown文件</div>';
                return;
            }
            
            try {
                const response = await fetch(mdFile);
                if (!response.ok) {
                    throw new Error('文件加载失败');
                }
                
                const markdownText = await response.text();
                const htmlContent = marked.parse(markdownText);
                
                contentDiv.innerHTML = htmlContent;
                
                // 为标题添加ID
                const headings = contentDiv.querySelectorAll('h2, h3, h4, h5, h6');
                headings.forEach((heading, index) => {
                    if (!heading.id) {
                        heading.id = `heading-${index}`;
                    }
                });
                
                // 生成目录
                generateTOC(contentDiv.innerHTML);
                
                // 平滑滚动
                document.querySelectorAll('.md-sidebar a').forEach(link => {
                    link.addEventListener('click', function(e) {
                        e.preventDefault();
                        const target = document.querySelector(this.getAttribute('href'));
                        if (target) {
                            target.scrollIntoView({ behavior: 'smooth' });
                        }
                    });
                });
                
                // 高亮当前章节
                window.addEventListener('scroll', () => {
                    const headings = contentDiv.querySelectorAll('h2, h3, h4, h5, h6');
                    const tocLinks = document.querySelectorAll('.md-sidebar a');
                    
                    let current = '';
                    headings.forEach(heading => {
                        const rect = heading.getBoundingClientRect();
                        if (rect.top <= 100) {
                            current = heading.id;
                        }
                    });
                    
                    tocLinks.forEach(link => {
                        link.classList.remove('active');
                        if (link.getAttribute('href') === `#${current}`) {
                            link.classList.add('active');
                        }
                    });
                });
                
            } catch (error) {
                contentDiv.innerHTML = `<div class="error">加载失败: ${error.message}</div>`;
            }
        }

        // 页面加载完成后执行
        document.addEventListener('DOMContentLoaded', loadMarkdown);
    </script>
</body>
</html>